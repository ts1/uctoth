#!/usr/bin/env coffee

fs = require 'fs'
sqlite3 = require('sqlite3').verbose()
{ round_value } = require './util'

args = process.argv.slice 2
if args.length != 2
  process.stderr.write "Usage: #{process.argv[1]} book.db out.json\n"
  process.exit 1
[dbname, outname] = args

db = new sqlite3.Database dbname
db.run 'pragma busy_timeout=5000'
db.run 'pragma journal_mode=WAL'
book = {}
db.all 'select * from book where n >= 100', [], (err, rows) ->
  throw err if err
  for row in rows
    book[row.code] = {n:row.n, value:round_value(row.value)}
  fs.writeFileSync outname, JSON.stringify book
  db.close()
  console.log "#{rows.length} positions"
